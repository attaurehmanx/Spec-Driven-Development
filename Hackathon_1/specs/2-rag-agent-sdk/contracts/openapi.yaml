openapi: 3.0.3
info:
  title: RAG Pipeline API
  description: API for the RAG (Retrieval-Augmented Generation) pipeline that uses OpenAI Agents SDK with Qdrant vector database to answer questions about book content.
  version: 1.0.0
servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.rag-pipeline.example.com
    description: Production server

paths:
  /api/agent/init:
    post:
      summary: Initialize an AI agent with tracing enabled
      description: Creates a new AI agent instance configured for RAG functionality with tracing enabled
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentInitRequest'
      responses:
        '200':
          description: Agent initialized successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentInitResponse'
        '400':
          description: Invalid configuration parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error during initialization
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/query:
    post:
      summary: Process a user query with RAG
      description: Takes a user query, retrieves relevant content from Qdrant, and generates a contextual response
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QueryRequest'
      responses:
        '200':
          description: Query processed successfully with contextual response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueryResponse'
        '400':
          description: Invalid query format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error during processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/retrieve:
    post:
      summary: Retrieve relevant content chunks from Qdrant
      description: Converts query to embeddings and retrieves relevant content chunks from the vector database
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RetrieveRequest'
      responses:
        '200':
          description: Relevant content chunks retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RetrieveResponse'
        '400':
          description: Invalid query format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error during retrieval
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/validate:
    post:
      summary: Validate an agent response
      description: Validates that an agent response is grounded in the provided context
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateRequest'
      responses:
        '200':
          description: Response validation completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateResponse'
        '400':
          description: Invalid validation request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error during validation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    AgentInitRequest:
      type: object
      required:
        - model
        - tracing_enabled
      properties:
        model:
          type: string
          description: The model to use for the agent (e.g., gemini-pro)
          example: "gemini-pro"
        tracing_enabled:
          type: boolean
          description: Whether to enable tracing for the agent
          example: true
        qdrant_config:
          $ref: '#/components/schemas/QdrantConfig'
        system_prompt:
          type: string
          description: Optional system prompt for the agent
          example: "You are a helpful assistant for book content."

    QdrantConfig:
      type: object
      required:
        - url
        - collection
      properties:
        url:
          type: string
          description: The Qdrant database URL
          example: "https://your-qdrant-instance.com"
        collection:
          type: string
          description: The collection name in Qdrant
          example: "book_content"
        api_key:
          type: string
          description: Optional API key for Qdrant
          example: "your-qdrant-api-key"

    AgentInitResponse:
      type: object
      required:
        - agent_id
        - status
      properties:
        agent_id:
          type: string
          description: The unique identifier for the initialized agent
          example: "agent-12345"
        status:
          type: string
          description: The initialization status
          enum: [initialized, error]
          example: "initialized"
        message:
          type: string
          description: Optional status message
          example: "Agent initialized successfully with tracing enabled"

    QueryRequest:
      type: object
      required:
        - query
      properties:
        agent_id:
          type: string
          description: Optional agent ID if using an existing agent
          example: "agent-12345"
        query:
          type: string
          description: The user's question about book content
          example: "What are the key concepts in chapter 3?"
        session_id:
          type: string
          description: Optional session ID for follow-up questions
          example: "session-67890"
        top_k:
          type: integer
          description: Number of chunks to retrieve (default 5)
          default: 5
          example: 5

    QueryResponse:
      type: object
      required:
        - response
        - trace_id
      properties:
        response:
          type: string
          description: The agent's response to the query
          example: "Chapter 3 covers the fundamental concepts of..."
        retrieved_chunks:
          type: array
          items:
            $ref: '#/components/schemas/RetrievedChunk'
          description: The chunks used to generate the response
        trace_id:
          type: string
          description: The trace ID for logging and debugging
          example: "trace-abc123"
        confidence_score:
          type: number
          format: float
          description: The confidence score of the response (0.0-1.0)
          example: 0.85

    RetrieveRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: The query text to search for
          example: "machine learning concepts"
        top_k:
          type: integer
          description: Number of results to return (default 5)
          default: 5
          example: 5
        filters:
          type: object
          description: Optional metadata filters
          example: {"source_document": "chapter3.md"}

    RetrieveResponse:
      type: object
      required:
        - chunks
      properties:
        chunks:
          type: array
          items:
            $ref: '#/components/schemas/RetrievedChunk'
          description: The retrieved content chunks
        query_embedding:
          type: array
          items:
            type: number
            format: float
          description: The embedding of the input query
          example: [0.1, 0.2, 0.3, 0.4]

    RetrievedChunk:
      type: object
      required:
        - content
        - score
      properties:
        content:
          type: string
          description: The retrieved text content
          example: "Machine learning is a subset of artificial intelligence..."
        score:
          type: number
          format: float
          description: The relevance score (0.0-1.0)
          example: 0.92
        source_document:
          type: string
          description: The source document of the chunk
          example: "chapter3.md"
        page_number:
          type: integer
          description: The page number in the source
          example: 45
        metadata:
          type: object
          description: Additional metadata about the chunk
          example: {"section": "introduction", "keywords": ["ML", "AI"]}

    ValidateRequest:
      type: object
      required:
        - response
        - context
      properties:
        response:
          type: string
          description: The agent response to validate
          example: "The concept was introduced in chapter 3..."
        context:
          type: string
          description: The context used to generate the response
          example: "Chapter 3 discusses the foundational concepts..."
        query:
          type: string
          description: The original query
          example: "When was this concept introduced?"

    ValidateResponse:
      type: object
      required:
        - is_valid
        - confidence
      properties:
        is_valid:
          type: boolean
          description: Whether the response is grounded in the context
          example: true
        confidence:
          type: number
          format: float
          description: Confidence in the validation result (0.0-1.0)
          example: 0.95
        feedback:
          type: string
          description: Optional validation feedback
          example: "Response is well-grounded in provided context"

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: The error code
          example: "INVALID_QUERY"
        message:
          type: string
          description: The error message
          example: "Query must not be empty"
        details:
          type: object
          description: Optional error details
          example: {"field": "query", "reason": "must not be empty"}

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT